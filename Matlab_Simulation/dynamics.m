function Fmatrix = dynamics(t,x)

global ma mb m1 m2 I1 I2 l1 l2 lc1 lc2 g

global t_prev fi1dot_prev fi2dot_prev P_hat_1_dot_prev P_hat_2_dot_prev P_hat_1_prev P_hat_2_prev

%-------------------------------------------------------------------------%
% x(1) = fi1 
% x(2) = fi1dot 
% x(3) = fi2
% x(4) = fi2dot
%-------------------------------------------------------------------------%
fi1 = x(1);
fi1dot = x(2);
fi2 = x(3);
fi2dot = x(4);


%-------------------------------------------------------------------------%
% Torques
%-------------------------------------------------------------------------%
[tau1, tau2, fi1dot_prev, fi2dot_prev,t_prev,P_hat_1_dot_prev,...
    P_hat_2_dot_prev,P_hat_1_prev,P_hat_2_prev, e1,e2] = ...
    controller_model_based(l1,l2,lc1,lc2,m1,m2,ma,mb,I1,I2,g,...
    t,fi1,fi1dot,fi2,fi2dot, fi1dot_prev,fi2dot_prev,t_prev,...
    P_hat_1_dot_prev,P_hat_2_dot_prev,P_hat_1_prev,P_hat_2_prev);


%-------------------------------------------------------------------------%
% F matrix
%-------------------------------------------------------------------------%
Fmatrix = zeros(4,1);


%-------------------------------------------------------------------------%
% from Mathematica we get
%-------------------------------------------------------------------------%
Fmatrix(2)=tau1+(-1).*g.*(lc1.*m1+l1.*(m2+ma+mb)).*cos(fi1)+(-1).*g.*( ...
  lc2.*m2+l2.*mb).*cos(fi1+fi2)+fi2dot.*(2.*fi1dot+fi2dot).* ...
  l1.*(lc2.*m2+l2.*mb).*sin(fi2);

Fmatrix(4)=tau2+(-1).*g.*(lc2.*m2+l2.*mb).*cos(fi1+fi2)+(-1).* ...
  fi1dot.^2.*l1.*(lc2.*m2+l2.*mb).*sin(fi2);


%-------------------------------------------------------------------------%
% We add the odd elements
%-------------------------------------------------------------------------%
Fmatrix(1) = fi1dot;
Fmatrix(3) = fi2dot;


%-------------------------------------------------------------------------%
% Printing time
%-------------------------------------------------------------------------%
disp(t) 
